<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>正在導向至 LINE OA...</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
    <div style="text-align: center; margin-top: 50px; font-family: sans-serif;">
        <p>正在為您綁定專屬參數，請稍候...</p>
        <p id="status" style="color: #666; font-size: 14px;"></p>
        <div style="margin-top: 8px;">
            <button id="closeBtn" style="display:none; padding: 6px 12px;">打開 moran 聊天室</button>
        </div>
    </div>

    <script>
        async function main() {
            const statusEl = document.getElementById('status');
            const closeBtn = document.getElementById('closeBtn');
            const setStatus = (msg) => {
                if (statusEl) statusEl.textContent = msg;
            };
            const showActions = () => {
                if (closeBtn) closeBtn.style.display = 'inline-block';
            };
            const openMoranChat = () => {
                // Always open OA chat without prefilled text
                const fallbackUrl = "https://line.me/R/ti/p/@378zbktg";
                if (window.liff) {
                    liff.openWindow({ url: fallbackUrl, external: true });
                } else {
                    window.location.href = fallbackUrl;
                }
            };
            // 1. 初始化 LIFF
            await liff.init({ liffId: "2008731710-UlxVqq0d" });

            if (!liff.isLoggedIn()) {
                setStatus("正在導向登入...");
                liff.login();
            } else {
                if (!liff.isInClient()) {
                    setStatus("請用 LINE App 開啟此連結，將導向 moran OA");
                    openMoranChat();
                    return;
                }
                // 2. 取得網址參數
                const urlParams = new URLSearchParams(window.location.search);
                const myParam = urlParams.get('ref'); 

                // 3. 確認目前是不是在 OA 一對一聊天室開啟
                const context = liff.getContext ? liff.getContext() : null;
                const contextType = context && context.type ? context.type : "unknown";
                if (contextType !== "utou") {
                    setStatus("請從 moran OA 聊天室開啟此連結，避免送到其他聊天室");
                    openMoranChat();
                    showActions();
                    return;
                }

                // 4. 依參數送出對應關鍵字，觸發後台自動回應
                const keywordMap = {
                    annie12345678: "annie12345678",
                    annie99999999: "annie99999999"
                };
                const keyword = keywordMap[myParam];
                if (keyword) {
                    setStatus("正在送出關鍵字...");
                    try {
                        await liff.sendMessages([{
                            type: 'text',
                            text: keyword
                        }]);
                        setStatus("關鍵字已送出，正在導向 moran OA...");
                    } catch (err) {
                        console.error("傳送失敗", err);
                        setStatus("關鍵字送出失敗，請確認已加好友並開啟 chat_message.write 權限");
                    }
                } else {
                    setStatus("參數不符，仍將導向 moran OA...");
                }
                setTimeout(openMoranChat, 300);
                showActions();
            }
        }
        main();
    </script>
    <script>
        const closeBtn = document.getElementById('closeBtn');
        if (closeBtn) {
            closeBtn.textContent = '打開 moran 聊天室';
            closeBtn.addEventListener('click', () => {
                const fallbackUrl = "https://line.me/R/ti/p/@378zbktg";
                if (window.liff) {
                    liff.openWindow({ url: fallbackUrl, external: true });
                } else {
                    window.location.href = fallbackUrl;
                }
            });
        }
    </script>
</body>
</html>