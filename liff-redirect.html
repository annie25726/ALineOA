<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>正在導向至 LINE OA...</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
    <div style="text-align: center; margin-top: 50px; font-family: sans-serif;">
        <p>正在為您綁定專屬參數，請稍候...</p>
        <p id="status" style="color: #666; font-size: 14px;"></p>
        <p id="prefill" style="display:none; margin-top: 8px; color: #333;"></p>
        <div style="margin-top: 8px;">
            <button id="copyBtn" style="display:none; padding: 6px 12px;">複製開頭語</button>
            <button id="closeBtn" style="display:none; margin-left: 8px; padding: 6px 12px;">打開 moran 聊天室</button>
        </div>
    </div>

    <script>
        async function main() {
            const statusEl = document.getElementById('status');
            const prefillEl = document.getElementById('prefill');
            const copyBtn = document.getElementById('copyBtn');
            const closeBtn = document.getElementById('closeBtn');
            const setStatus = (msg) => {
                if (statusEl) statusEl.textContent = msg;
            };
            const showActions = () => {
                if (copyBtn) copyBtn.style.display = 'inline-block';
                if (closeBtn) closeBtn.style.display = 'inline-block';
            };
            let messageText = "";
            const openMoranChat = () => {
                const baseUrl = "https://line.me/R/oaMessage/@378zbktg/";
                const url = messageText
                    ? `${baseUrl}?text=${encodeURIComponent(messageText)}`
                    : "https://line.me/R/ti/p/@378zbktg";
                if (window.liff) {
                    liff.openWindow({ url, external: true });
                } else {
                    window.location.href = url;
                }
            };
            // 1. 初始化 LIFF
            await liff.init({ liffId: "2008731710-UlxVqq0d" });

            if (!liff.isLoggedIn()) {
                setStatus("正在導向登入...");
                liff.login();
            } else {
                if (!liff.isInClient()) {
                    setStatus("請用 LINE App 開啟此連結，將導向 moran OA");
                    openMoranChat();
                    return;
                }
                // 2. 取得網址參數
                const urlParams = new URLSearchParams(window.location.search);
                const myParam = urlParams.get('ref'); 

                // 3. 不論從哪個聊天室開啟，一律導向 moran OA
                if (myParam === "annie12345678") {
                    messageText = "你好我是第一個anie12345678進來的";
                    setStatus("正在導向 moran OA，並帶入開頭語...");
                } else {
                    setStatus("參數不符，仍將導向 moran OA...");
                }
                if (messageText && prefillEl) {
                    prefillEl.style.display = 'block';
                    prefillEl.textContent = `開頭語：${messageText}`;
                }
                openMoranChat();
                showActions();
            }
        }
        main();
    </script>
    <script>
        const copyBtn = document.getElementById('copyBtn');
        const closeBtn = document.getElementById('closeBtn');
        if (copyBtn) {
            copyBtn.addEventListener('click', async () => {
                if (!messageText) return;
                try {
                    await navigator.clipboard.writeText(messageText);
                    copyBtn.textContent = '已複製';
                } catch {
                    copyBtn.textContent = '無法複製';
                }
            });
        }
        if (closeBtn) {
            closeBtn.textContent = '打開 moran 聊天室';
            closeBtn.addEventListener('click', () => {
                const baseUrl = "https://line.me/R/oaMessage/@378zbktg/";
                const url = messageText
                    ? `${baseUrl}?text=${encodeURIComponent(messageText)}`
                    : "https://line.me/R/ti/p/@378zbktg";
                if (window.liff) {
                    liff.openWindow({ url, external: true });
                } else {
                    window.location.href = url;
                }
            });
        }
    </script>
</body>
</html>