<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>正在導向至 LINE OA...</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
    <div style="text-align: center; margin-top: 50px; font-family: sans-serif;">
        <p>正在為您綁定專屬參數，請稍候...</p>
        <p id="status" style="color: #666; font-size: 14px;"></p>
        <button id="closeBtn" style="display:none; margin-top: 12px; padding: 8px 14px;">返回聊天室</button>
    </div>

    <script>
        async function main() {
            const statusEl = document.getElementById('status');
            const closeBtn = document.getElementById('closeBtn');
            const setStatus = (msg) => {
                if (statusEl) statusEl.textContent = msg;
            };
            const showClose = () => {
                if (closeBtn) closeBtn.style.display = 'inline-block';
            };
            // 1. 初始化 LIFF
            await liff.init({ liffId: "2008731710-UlxVqq0d" });

            if (!liff.isLoggedIn()) {
                setStatus("正在導向登入...");
                liff.login();
            } else {
                if (!liff.isInClient()) {
                    setStatus("請用 LINE App 開啟此連結");
                    return;
                }
                // 2. 取得網址參數
                const urlParams = new URLSearchParams(window.location.search);
                const myParam = urlParams.get('ref'); 

                // 3. 邏輯判斷：如果有特定參數，就發送對應訊息
                if (myParam === "annie12345678") {
                    setStatus("正在傳送訊息...");
                    try {
                        await liff.sendMessages([{
                            type: 'text',
                            text: '你好我是第一個anie12345678進來的' // 這會觸發你的關鍵字回應
                        }]);
                        setStatus("訊息已送出，請回到聊天室查看");
                        showClose();
                    } catch (err) {
                        console.error("傳送失敗", err);
                        setStatus("傳送失敗，請先加入好友並確認 chat_message.write 權限");
                        showClose();
                    }
                } else {
                    setStatus("參數不符，請確認連結");
                    showClose();
                }
            }
        }
        main();
    </script>
    <script>
        const closeBtn = document.getElementById('closeBtn');
        if (closeBtn) {
            closeBtn.addEventListener('click', () => {
                if (window.liff && liff.isInClient()) {
                    liff.closeWindow();
                }
            });
        }
    </script>
</body>
</html>