<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>正在導向至 LINE OA...</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
    <div style="text-align: center; margin-top: 50px; font-family: sans-serif;">
        <p>正在為您綁定專屬參數，請稍候...</p>
        <p id="status" style="color: #666; font-size: 14px;"></p>
        <p id="debug" style="color: #999; font-size: 12px; margin-top: 6px;"></p>
        <div style="margin-top: 8px;">
            <button id="closeBtn" style="display:none; padding: 6px 12px;">打開 moran 聊天室</button>
        </div>
    </div>

    <script>
        async function main() {
            const statusEl = document.getElementById('status');
            const debugEl = document.getElementById('debug');
            const closeBtn = document.getElementById('closeBtn');
            const setStatus = (msg) => {
                if (statusEl) statusEl.textContent = msg;
            };
            const setDebug = (msg) => {
                if (debugEl) debugEl.textContent = msg;
            };
            const showActions = () => {
                if (closeBtn) closeBtn.style.display = 'inline-block';
            };
            const openMoranChat = () => {
                // Always open OA chat without prefilled text
                const fallbackUrl = "https://line.me/R/ti/p/@378zbktg";
                if (window.liff) {
                    liff.openWindow({ url: fallbackUrl, external: true });
                } else {
                    window.location.href = fallbackUrl;
                }
            };
            const BACKEND_URL = "https://YOUR-RENDER-SERVICE.onrender.com";
            // 1. 初始化 LIFF
            await liff.init({ liffId: "2008731710-UlxVqq0d" });
            setDebug(`env: inClient=${liff.isInClient()} loggedIn=${liff.isLoggedIn()}`);

            if (!liff.isLoggedIn()) {
                setStatus("正在導向登入...");
                liff.login();
            } else {
                if (!liff.isInClient()) {
                    setStatus("請用 LINE App 開啟此連結，將導向 moran OA");
                    openMoranChat();
                    return;
                }
                // 2. 取得網址參數
                const urlParams = new URLSearchParams(window.location.search);
                const myParam = urlParams.get('ref'); 
                setDebug(`ref=${myParam || "(none)"}`);

                // 3. 呼叫後端推播對應訊息
                if (myParam) {
                    setStatus("正在推播訊息...");
                    try {
                        const profile = await liff.getProfile();
                        const res = await fetch(`${BACKEND_URL}/api/push`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                userId: profile.userId,
                                ref: myParam
                            })
                        });
                        const data = await res.json().catch(() => ({}));
                        if (!res.ok) {
                            throw new Error(data.error || "push failed");
                        }
                        setStatus("推播已送出，正在導向 moran OA...");
                        setDebug(`pushed=${myParam}`);
                    } catch (err) {
                        console.error("傳送失敗", err);
                        setStatus("推播失敗，請確認已加好友與後端設定");
                        setDebug(`error=${err && err.message ? err.message : String(err)}`);
                    }
                } else {
                    setStatus("參數不符，仍將導向 moran OA...");
                    setDebug("no ref parameter");
                }
                setStatus("10 秒後導向 moran OA...");
                setTimeout(openMoranChat, 10000);
                showActions();
            }
        }
        main();
    </script>
    <script>
        const closeBtn = document.getElementById('closeBtn');
        if (closeBtn) {
            closeBtn.textContent = '打開 moran 聊天室';
            closeBtn.addEventListener('click', () => {
                const fallbackUrl = "https://line.me/R/ti/p/@378zbktg";
                if (window.liff) {
                    liff.openWindow({ url: fallbackUrl, external: true });
                } else {
                    window.location.href = fallbackUrl;
                }
            });
        }
    </script>
</body>
</html>